services:
  # 1) Одноразовая генерация сертификатов (ручной запуск: docker compose run --rm certgen)
  certgen:
    build:
      context: ./certgen
      dockerfile: Dockerfile
    environment:
      OUT_DIR: /secrets
      PASSWORD: ${SSL_STORE_PASSWORD}
      BROKERS: kafka-1,kafka-2,kafka-3
      CLIENTS: admin,client-producer,client-consumer
    volumes:
      - ./secrets:/secrets
      - zookeeper-data:/var/lib/zookeeper
    networks: [knet]

  # 2) Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "22181:2181"
    healthcheck:
      test: ["CMD-SHELL", "echo srvr | nc -w 2 127.0.0.1 2181 | grep -q 'Mode' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 10s
    restart: unless-stopped
    networks: [knet]

  # 3) Брокер 1
  kafka-1:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka-1
    hostname: kafka-1
    user: "0:0"
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "${KAFKA1_PORT}:9094"     # внешний порт -> EXTERNAL_SSL
    command: ["/bin/bash","-lc","cp -a /secrets-src/. /secrets/ && chmod -R a+rX /secrets && exec /usr/bin/kafka-server-start /kafka-config/server.properties"]
    volumes:
      - ./kafka/broker-1/server.properties:/kafka-config/server.properties:ro
      - ./secrets:/secrets-src:ro
      - secrets-broker-1:/secrets
      - kafka-1-data:/var/lib/kafka/data
      - ./clients:/clients:ro
      - ./init:/init:ro            # <-- скрипты теперь запускаем отсюда вручную на kafka-1
    restart: unless-stopped
    networks: [knet]

  # 4) Брокер 2
  kafka-2:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka-2
    hostname: kafka-2
    user: "0:0"
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "${KAFKA2_PORT}:9094"
    command: ["/bin/bash","-lc","cp -a /secrets-src/. /secrets/ && chmod -R a+rX /secrets && exec /usr/bin/kafka-server-start /kafka-config/server.properties"]
    volumes:
      - ./kafka/broker-2/server.properties:/kafka-config/server.properties:ro
      - ./secrets:/secrets-src:ro
      - secrets-broker-2:/secrets
      - kafka-2-data:/var/lib/kafka/data
      - ./clients:/clients:ro
    restart: unless-stopped
    networks: [knet]

  # 5) Брокер 3
  kafka-3:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka-3
    hostname: kafka-3
    user: "0:0"
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "${KAFKA3_PORT}:9094"
    command: ["/bin/bash","-lc","cp -a /secrets-src/. /secrets/ && chmod -R a+rX /secrets && exec /usr/bin/kafka-server-start /kafka-config/server.properties"]
    volumes:
      - ./kafka/broker-3/server.properties:/kafka-config/server.properties:ro
      - ./secrets:/secrets-src:ro
      - secrets-broker-3:/secrets
      - kafka-3-data:/var/lib/kafka/data
      - ./clients:/clients:ro
    restart: unless-stopped
    networks: [knet]

networks:
  knet: {}

volumes:
  zookeeper-data: {}
  kafka-1-data: {}
  kafka-2-data: {}
  kafka-3-data: {}
  secrets-broker-1: {}
  secrets-broker-2: {}
  secrets-broker-3: {}
